åœ¨å­¦ä¹ è¯¥å ä½ç¬¦çš„ä½¿ç”¨ä¸åŸç†ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå­¦ä¹ ä¸€ä¸‹Springçš„è‡ªå®šä¹‰æ ‡ç­¾
å‚è€ƒï¼š./other/01-springè‡ªå®šä¹‰è§£æ.txt

æœ¬ç¯‡æ‰€ä½¿ç”¨çš„æµ‹è¯•ç±»å¦‚ä¸‹
é¡¹ç›®:rookie-spring-framework-web
æµ‹è¯•ç±»ï¼šcom.rookie.bigdata.springframework.context.propertysources.PropertyConfigTest#testXml()

å¤„ç†æµç¨‹å›¾ï¼š
./pic/lifecycle/å ä½ç¬¦/01_å ä½ç¬¦.png

org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader#parseBeanDefinitions()
    1ã€PropertySourcesPlaceholderConfigureråˆ†æ
    --->org.springframework.context.config.PropertyPlaceholderBeanDefinitionParser#parse()

1   PropertySourcesPlaceholderConfigureråˆ†æ
    1.1 PropertySourcesPlaceholderConfigurerç±»çš„è§£ææ˜¯é€šè¿‡è¿›è¡Œä¸Šé¢å¯¹xmlæ–‡ä»¶è§£æï¼Œç„¶åç”ŸæˆBeanDefintion,åç»­è¿›è¡Œå®ä¾‹åŒ–ã€‚


2   PropertySourcesPlaceholderConfigureråŸç†
    2.1 å‰ç½®çŸ¥è¯†
        2.1.1   Propertiesç±»å‹ä»‹ç»
            Propertiesç»§æ‰¿äº†Hashtableï¼Œå› æ­¤å¯ä»¥çœ‹ä½œä¸€ä¸ªç‰¹æ®Šçš„Mapç±»å‹(åŠŸèƒ½åŠ å¼ºçš„Map), å› æ­¤Propertiesä¹ŸåŸºäºé”®å€¼å¯¹çš„å­˜å‚¨ç»“æ„æä¾›äº†å¾ˆå¤šæ¥å£,Propertieså¯ä»¥è¢«ç”¨æ¥ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½èµ„æºå…¥å†…å­˜ã€‚
        2.1.2   PropertySourceç±»å‹ä»‹ç»
            æŠ½è±¡ç±»PropertySourceè¢«å®šä¹‰ä¸ºèµ„æºå¯¹è±¡ï¼Œå†…éƒ¨å­˜åœ¨ä¸¤ä¸ªå±æ€§ï¼šnameå’Œæ³›å‹çš„sourceå¯¹è±¡ã€‚é€šè¿‡equalså’ŒhashCodeæ–¹æ³•å¯çŸ¥nameå±æ€§è¢«ä½œä¸ºåˆ¤æ–­PropertySourceå¯¹è±¡æ˜¯å¦ç›¸ç­‰çš„ä¾æ®
            å®šä¹‰ç±»ä¸€ä¸ªæŠ½è±¡çš„getProperty(String propertyName)æ–¹æ³•ç»™è‡ªç±»å®ç°ï¼Œæ¥å£çš„åŠŸèƒ½æ˜¯æ ¹æ®propertyNameä»sourceå±æ€§ä¸­å–å€¼ï¼›éœ€è¦æ³¨æ„propertyNameä¸PropertySourceä¸­çš„nameå±æ€§ä¸æ˜¯åŒä¸€æ¦‚å¿µ(nameä»…ä½œä¸ºPropertySourceå¯¹è±¡å¯¹å¤–çš„èº«ä»½)ã€‚PropertySourceæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„å®ç°ç±»ï¼šPropertiesPropertySourceå’ŒResourcePropertySource
            PropertiesPropertySourceçš„sourceå±æ€§ä¸ºPropertiesç±»å‹ï¼›æ³¨æ„Propertiesæ˜¯Hashtableçš„å­ç±»ï¼Œè‡ªç„¶ä¹Ÿæ˜¯Mapç±»å‹çš„å­ç±»ã€‚å…¶çˆ¶ç±»MapPropertySourceå®ç°äº†PropertySourceå®šä¹‰çš„Object getProperty(String name)æ¥å£,æ ¹æ®keyä»Mapç±»å‹çš„sourceå¯¹è±¡ä¸­å–å€¼ã€‚
            PropertySourceçš„å®ç°ç±»ResourcePropertySourceï¼š
            ResourcePropertySourceä½œä¸ºPropertiesPropertySourceçš„å­ç±»ï¼Œåœ¨PropertiesPropertySourceåŸºç¡€ä¸Šæ–°å¢äº†è¯»å–èµ„æºæ–‡ä»¶çš„èƒ½åŠ›ã€‚å…¶ä¸­PropertiesLoaderUtils.loadProperties(new EncodedResource(resource)))ä¼šæ ¹æ®ä¼ å…¥çš„Resourceå¯¹è±¡æŒ‡å®šçš„æ–‡ä»¶èµ„æºå»åŠ è½½ã€è¯»å–å¹¶ç”ŸæˆPropertieså¯¹è±¡ã€‚
            PropertySourceçš„å®¹å™¨ç±»MutablePropertySourcesï¼š
            MutablePropertySourcesä½œä¸ºPropertySourceçš„å®¹å™¨ï¼Œåœ¨å†…éƒ¨ç»´æŒäº†ä¸€ä¸ªPropertySourceç±»å‹çš„åˆ—è¡¨ï¼ŒåŸºäºæ­¤å¯¹å¤–æä¾›äº†å­˜å‚¨ã€ç®¡ç†ã€æŸ¥è¯¢PropertySourceå¯¹è±¡èƒ½åŠ›çš„API
        2.1.3   PropertyResolverç±»å‹ä»‹ç»
            PropertyResolveræ¥å£å®šä¹‰äº†æ ¹æ®keyè·å–valueä»¥åŠå¤„ç†å ä½ç¬¦å­—ç¬¦ä¸²çš„èƒ½åŠ›ã€‚PropertyResolverçš„å®ç°ç±»PropertySourcesPropertyResolverï¼šå®ä¾‹åŒ–PropertySourcesPropertyResolverå¯¹è±¡æ—¶ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªPropertySourcesä½œä¸ºå…¥å‚ã€‚String getProperty(String key)åŠå…¶é‡è½½æ–¹æ³•å–å€¼çš„å®ç°åŸç†ï¼šéå†propertySourceså¯¹è±¡å†…éƒ¨çš„PropertySourceå¯¹è±¡ï¼Œä¾æ¬¡ä»ä¸­å–å€¼ï¼Œç›´åˆ°å–å€¼æˆåŠŸæˆ–è€…éå†è‡³æœ€åä¸€ä¸ªPropertySourceå¯¹è±¡ã€‚String resolvePlaceholders(String text)çš„å…¥å‚ä¸ºå¾…è§£æçš„å­—ç¬¦ä¸²(åŒ…å«å ä½ç¬¦)ï¼Œè¿”å›çš„å­—ç¬¦ä¸²ä¸ºè§£æåçš„ç»“æœã€‚è§£æè¿‡ç¨‹ä¸­éœ€è¦é€šè¿‡String getProperty(String key)åŠå…¶é‡è½½æ–¹æ³•ä»PropertySourceå¯¹è±¡åˆ—è¡¨ä¸­å–å€¼ã€‚ä»£ç çš„æ•´ä½“é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡é€’å½’æ“ä½œğŸ¥·å…ˆè§£ææœ€å†…ä¾§çš„å ä½ç¬¦ï¼Œå¾—åˆ°ä¸€ä¸ªä¸­é—´å€¼propVal(æ¥æºäºé…ç½®æ–‡ä»¶æˆ–è€…ç¯å¢ƒå˜é‡ç­‰)ï¼›propValå¯èƒ½ä¹ŸåŒ…å«å ä½ç¬¦ï¼Œå› æ­¤ä¹Ÿéœ€è¦å¯¹å…¶è¿›è¡Œè§£æã€‚é€’å½’è¿”å›åï¼Œä¼šæŒ‰ç…§ç”±å¤–åˆ°å†…çš„é¡ºåºä¾æ¬¡è¿›è¡Œã€‚
            2.1.3.1 è§£ææœ€ç»ˆè°ƒç”¨çš„æ˜¯org.springframework.util.PropertyPlaceholderHelper#parseStringValue()è¿™ä¸ªæ–¹æ³•
                1   å…ˆæ‹¿åˆ°è¦æ›¿æ¢çš„å€¼ï¼ˆå³ï¼š${xx}ä¸­çš„xx)
                2   é€’å½’è§£æï¼Œæ‹¿åˆ°çœŸæ­£è¦æ›¿æ¢çš„å€¼ï¼ˆå³æœ‰å¯èƒ½æ˜¯${${}/xx}è¿™æ ·çš„ï¼‰
                3   è°ƒç”¨placeholderResolverçš„resolvePlaceholderæ–¹æ³•æ‹¿åˆ°å±æ€§å€¼ï¼ˆå…¶å®å°±ä¼šè°ƒç”¨ä¸Šé¢ä¼ é€’çš„getPropertyAsRawStringæ–¹æ³•ï¼‰
                4   å¦‚æœå±æ€§å€¼ä¸ºç©ºï¼Œå¯èƒ½æ˜¯æœ‰é»˜è®¤å€¼åˆ†éš”ç¬¦ï¼ˆå³æœ‰ï¼šï¼‰,ä¸€ç•ªå¤„ç†åæ‹¿åˆ°å±æ€§å€¼
                5   å¯¹å±æ€§å€¼è¿›è¡Œé€’å½’è§£æï¼Œæ‹¿åˆ°æœ€ç»ˆå±æ€§å€¼ï¼ˆå³å¯èƒ½æ˜¯åœ¨å±æ€§æ–‡ä»¶ä¸­å†™æ³•ï¼šxxx=${xxx},ä¸€èˆ¬æ˜¯å¤šä¸ªå±æ€§æ–‡ä»¶çš„æƒ…å†µï¼‰
                6   æœ€ç»ˆå±æ€§å€¼ä¸ä¸ºç©ºå°±æ›¿æ¢ï¼Œå¦åˆ™æ ¹æ® ignoreUnresolvablePlaceholdersåˆ¤æ–­æ˜¯å¦æŠ›å¼‚å¸¸è¿˜æ˜¯ç»§ç»­è§£æ
                7   æŠŠè§£ææˆåŠŸçš„è¦æ›¿æ¢çš„å€¼ä»visitedPlaceholdersä¸­ç§»é™¤
                8   ç»§ç»­å¾ªç¯æˆ–è¿”å›ç»“æœ

    2.2 åŸç†
        Springæ¡†æ¶å¤„ç†å ä½ç¬¦é—®é¢˜æ—¶é€‰æ‹©çš„ç›®æ ‡å¯¹è±¡æ˜¯BeanDefinitionï¼Œå› æ­¤æ— è®ºä»¥ä½•ç§æ–¹å¼å¼•å…¥çš„Beanï¼Œå¤„ç†è¿‡ç¨‹å‡å¯ç»Ÿä¸€ã€‚å…·ä½“çš„å®ç°æ–¹æ¡ˆæ˜¯å¼•å…¥ä¸€ä¸ªBeanFactoryPostProcessorç±»å‹çš„PropertySourcesPlaceholderConfigurerç±»ï¼Œå¹¶å°†è§£æé€»è¾‘å°è£…åœ¨å…¶å†…éƒ¨ï¼›åœ¨Springå®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡invokeBeanFactoryPostProcessors(beanFactory);è¿›è¡Œè§¦å‘ã€‚
        PropertySourcesPlaceholderConfigurerä¸­çš„postProcessBeanFactoryæ–¹æ³•ï¼š
            (1) æ„å»ºä¸€ä¸ªMutablePropertySourcesèµ„æºå¯¹è±¡å®¹å™¨ï¼›
            (2) å‘å…¶ä¸­åŠ å…¥åç§°ä¸ºenvironmentPropertiesçš„PropertySourceå¯¹è±¡ï¼ŒåŒ…å«äº†ç³»ç»Ÿå±æ€§ã€åº”ç”¨å±æ€§ã€ç¯å¢ƒå˜é‡ç­‰ä¿¡æ¯ï¼›å…¶ä¸­application.ymlä¸­é…ç½®çš„å±æ€§ä¹ŸåŒ…å«åœ¨å…¶ä¸­ï¼›
            (3) å‘å…¶ä¸­åŠ å…¥åç§°ä¸ºlocalPropertiesçš„PropertySourceå¯¹è±¡ï¼ŒåŒ…å«äº†å¼•å…¥çš„é…ç½®æ–‡ä»¶ä¸­çš„ä¿¡æ¯ï¼›
            (4) å°†MutablePropertySourcesä½œä¸ºæ„é€ å‚æ•°åˆ›å»ºä¸€ä¸ªPropertySourcesPropertyResolverè§£æå™¨å¯¹è±¡;
            (5) è°ƒç”¨processProperties(beanFactory, new PropertySourcesPropertyResolver(this.propertySources));å¤„ç†å ä½ç¬¦ã€‚
            processPropertiesæ–¹æ³•å…±ä¸¤ä¸ªå…¥å‚ï¼šbeanFactoryå’ŒPropertySourcesPropertyResolverè§£æå™¨å¯¹è±¡ï¼›beanFactoryå®¹å™¨èƒ½å¤Ÿè·å–æ‰€æœ‰çš„BeanDefinitionä¿¡æ¯ï¼ŒPropertySourcesPropertyResolverè§£æå™¨å¯¹è±¡å†…éƒ¨åŒ…å«äº†æ‰€æœ‰çš„é…ç½®ä¿¡æ¯ä»¥åŠåŸºäºæ­¤å°è£…çš„è§£æèƒ½åŠ›ã€‚





æ–‡ç« æ¥æºï¼š
https://blog.csdn.net/seasonLai/article/details/82994463
https://blog.csdn.net/weixin_41835612/article/details/107242055
https://blog.csdn.net/Sheng_Q/article/details/128277725
